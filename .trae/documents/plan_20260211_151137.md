作为 30 年经验的专家，我将为您构建一套**金融级的并发验证与库存回滚机制**。

### 1. 核心目标
*   **验证并发安全性**: 证明当 100 个请求同时争抢 1 个库存时，系统**绝对不会**卖出 2 个，且必须有 99 个请求失败。
*   **实现库存回滚**: 当订单被取消 (CANCELLED) 或超时未支付时，自动释放占用的库存，确保商品能再次售卖。

### 2. 实施计划 (Execution Plan)

#### 任务 A: 实现库存自动回滚逻辑
*   **修改 `OrdersService.updateStatus`**:
    *   当状态变更为 `CANCELLED` 时，遍历订单中的 `items`。
    *   使用 `Prisma.$transaction` 将每个 item 的 `quantity` 加回对应的 SKU `stock`。
    *   记录回滚日志（可选，但推荐）。

#### 任务 B: 编写高并发压力测试脚本
*   **工具选型**: 使用 Node.js 原生脚本配合 `Promise.all` 模拟并发，而非简单的 shell 脚本，以确保微秒级的同时请求。
*   **测试流程**:
    1.  **Setup**: 创建一个测试 SKU，设置库存为 1。
    2.  **Attack**: 启动 100 个并发 Worker，同时调用 `POST /orders` 尝试购买该 SKU。
    3.  **Assert**:
        *   期望结果：成功订单数 = 1。
        *   期望结果：失败订单数 = 99。
        *   期望结果：最终库存 = 0。
    4.  **Teardown**: 清理测试数据。

#### 任务 C: 验证回滚逻辑
*   **测试流程**:
    1.  取用上述成功的订单（状态 PENDING_PAYMENT）。
    2.  调用 `POST /orders/:id/status` 将其更为 `CANCELLED`。
    3.  **Assert**: 检查 SKU 库存是否恢复为 1。

### 3. 文件变更
*   修改: `backend/src/orders/orders.service.ts` (添加回滚逻辑)
*   新增: `backend/scripts/test-concurrency.ts` (压力测试脚本)

---

**您是否同意执行此计划？这将在您的本地环境中进行一次真实的“双十一”压力演习。**
