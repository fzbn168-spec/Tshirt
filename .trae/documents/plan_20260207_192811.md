# 阶段三：沟通效率 (询盘留言板) 开发计划

本阶段旨在为买家和管理员/业务员提供一个基于特定询价单 (Inquiry) 的沟通渠道，替代目前的静态备注功能。

## 1. 数据库架构变更 (Prisma)

* **新增** **`InquiryMessage`** **模型**:

  * `id`: UUID

  * `inquiryId`: 关联 Inquiry

  * `senderId`: 关联 User (发送者)

  * `content`: String (消息内容)

  * `createdAt`: DateTime (发送时间)

* **更新** **`Inquiry`** **模型**:

  * 增加 `messages` 关联。

## 2. 后端开发 (NestJS)

* **更新** **`InquiriesService`**:

  * `createMessage(inquiryId, userId, content)`: 保存消息，并触发通知。

  * `getMessages(inquiryId)`: 获取消息历史，按时间正序排列。

* **更新** **`InquiriesController`**:

  * `POST /inquiries/:id/messages`: 发送消息接口。

  * `GET /inquiries/:id/messages`: 获取消息列表接口。

* **通知集成**:

  * 当买家发送消息 -> 通知负责该企业的 Sales Rep (如有) 或 Admin。

  * 当 Admin/Sales Rep 发送消息 -> 通知买家。

## 3. 前端开发 (Next.js)

* **新建组件** **`InquiryChat`**:

  * 展示消息历史 (气泡样式，区分自己/对方)。

  * 简单的输入框和发送按钮。

  * 自动滚动到底部。

* **集成位置**:

  * **买家端**: `/dashboard/inquiries/[id]/page.tsx` (在明细列表下方添加)。

  * **管理端**: `/admin/inquiries/[id]/page.tsx` (在报价操作区下方添加)。

## 4. 执行步骤

1. 修改 `schema.prisma` 并迁移数据库。
2. 实现后端 Service 和 Controller 逻辑。
3. 开发前端 `InquiryChat` 组件并集成。
4. 验证双方收发消息是否通畅。

