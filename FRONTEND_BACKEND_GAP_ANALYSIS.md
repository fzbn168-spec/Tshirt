# 前后端集成验证与差距分析报告

**日期:** 2026-02-13
**范围:** 全栈 (NestJS 后端 + Next.js 前端)
**目标:** 验证系统集成情况，识别功能缺失，清理死代码/日志，并提供实施路线图。

## 1. 执行摘要

后端系统 (NestJS + Prisma) 功能强大且丰富，支持复杂的 B2B 业务流程（如阶梯定价、定制询盘、拆单发货、分批付款）。然而，前端 (Next.js) 目前在特定高级功能上略有滞后。核心的“产品 -> 询盘 -> 订单”流程虽然已经打通，但后端具备的许多高级 B2B 能力尚未在前端向用户展示。

**连接状态:** ✅ **已连接**。前端已成功调用后端 API 进行核心流程操作。
**同步状态:** ⚠️ **部分同步**。后端包含的高级逻辑（定价、物流）尚未在前端可视化。

## 2. 详细差距分析矩阵

### 2.1 产品模块 (目录 & 详情页)
| 功能特性 | 后端能力 (Backend) | 前端现状 (Frontend) | 缺失严重性 | 所需行动 |
| :--- | :--- | :--- | :--- | :--- |
| **阶梯定价** | `OrdersService` 和 `SKU` 模型中已包含逻辑 (`tierPrices` JSON 字段)。 | **缺失**。仅显示简单的最低价 `min(sku.price)`。 | 🔴 高 | 更新详情页 (PDP) 以解析 `tierPrices` 并显示价格表。 |
| **尺码表** | 完全支持 (`SizeChart` 模型)。 | ✅ **已实现**。`SizeChartModal` 弹窗工作正常。 | 🟢 低 | 无。 |
| **属性规格** | 支持动态属性。 | ✅ **已实现**。`SkuSelector` 选择器工作正常。 | 🟢 低 | 无。 |

### 2.2 询盘模块 (RFQ)
| 功能特性 | 后端能力 (Backend) | 前端现状 (Frontend) | 缺失严重性 | 所需行动 |
| :--- | :--- | :--- | :--- | :--- |
| **定制询盘** | `Inquiry` 模型包含 `notes` (备注), `attachments` (附件), `type` (标准/拿样)。 | **缺失**。没有针对“联系我们/定制需求”的无商品入口。 | 🔴 高 | 创建 `/custom-request` 页面。 |
| **附件上传** | 支持 `attachments` 字段 (JSON URL 数组)。 | **缺失**。询盘表单中没有上传文件的 UI。 | 🟠 中 | 在 RFQ 询价车中添加文件上传功能。 |
| **订单类型** | 支持 `SAMPLE` (样品单) vs `STANDARD` (标准单)。 | ⚠️ **部分**。默认为标准单。 | 🟠 中 | 在 RFQ 询价车中添加“索取样品”开关。 |

### 2.3 订单模块 (仪表盘)
| 功能特性 | 后端能力 (Backend) | 前端现状 (Frontend) | 缺失严重性 | 所需行动 |
| :--- | :--- | :--- | :--- | :--- |
| **物流信息** | `Order` 拥有 `shippings` 关联 (追踪号, 承运商)。 | **缺失**。订单详情页仅显示商品列表。 | 🔴 高 | 在订单详情页添加“物流/发货信息”板块。 |
| **支付凭证** | `Order` 拥有 `payments` 关联 (凭证 URL)。 | **缺失**。没有上传银行水单的 UI。 | 🔴 高 | 添加“上传支付凭证”按钮/弹窗。 |
| **PI 下载** | 存在端点 `GET /orders/:id/pi`。 | ⚠️ **部分**。前端有调用，但错误处理较基础。 | 🟢 低 | 验证 PDF 下载流程。 |

### 2.4 用户与公司模块
| 功能特性 | 后端能力 (Backend) | 前端现状 (Frontend) | 缺失严重性 | 所需行动 |
| :--- | :--- | :--- | :--- | :--- |
| **公司资料** | 支持完整的公司 CRUD 操作。 | ⚠️ **基础**。存在资料页但功能有限。 | 🟠 中 | 增强公司资料编辑功能。 |
| **销售代表** | 支持销售代表分配逻辑。 | **仅管理员可见**。前端用户看不到对应的销售代表信息。 | ⚪ 信息 | 在仪表盘添加“我的销售代表”小组件。 |

## 3. 代码质量与清理审计

### 3.1 死代码与冗余
- **后端脚本**: 在之前的优化中已移除了未使用的维护脚本 (`check-inquiry-type.ts` 等)。
- **前端**: `src/app` 目录结构整洁。没有明显的孤儿页面。
- **未使用逻辑**: `StripeService` 正确处理了 模拟/生产 模式。`EmailService` 正确处理了 模拟/生产 模式。

### 3.2 生产环境日志清理
已执行以下调试痕迹的移除操作：
1.  **前端**: 移除了 `UsersPage` 中的 `console.log('Fetching users...')`。
2.  **后端认证**: 移除了 `RolesGuard` 中的 `console.log` (用户角色检查)。
3.  **后端邮件**: 移除了邮件发送成功的 `console.log` (生产环境冗余)。
4.  **后端 Stripe**: 移除了 Mock 支付初始化的 `console.log`。

## 4. 实施路线图 (后续步骤)

### 第一阶段：补齐高严重性差距 (业务关键)
1.  **定制需求页面 (`/custom-request`)**:
    *   **前端**: 创建包含联系人信息、需求描述 (文本域) 和文件上传的表单。
    *   **后端**: 复用 `InquiriesController.create`，但当 `type=CUSTOM` 时允许 `items` 为空。
2.  **订单详情页增强**:
    *   **前端**: 在 `OrderDetailPage` 中获取 `shippings` 和 `payments` 数据。
    *   **UI**: 如果已发货，显示追踪号。如果待付款，显示支付状态和“上传凭证”按钮。

### 第二阶段：定价与转化优化
1.  **阶梯定价展示**:
    *   **前端**: 在 `ProductDetailClient` 中解析 `sku.tierPrices`。
    *   **UI**: 显示类似“买 10+ 件: $90, 买 50+ 件: $80”的价格表。
2.  **拿样流程**:
    *   **前端**: 在 RFQ 询价车中添加“样品订单”复选框。

### 第三阶段：管理与维护
1.  **公司资料**: 允许用户更新其公司地址/税务 ID（这对生成发票至关重要）。

## 5. 结论
“后端优先”的策略为您打下了坚实的基础。目前的脱节是分阶段上线过程中的典型现象，即 API 能力先于 UI 实现。通过执行 **第一阶段** 路线图，系统将实现前后端的“功能对齐”。
